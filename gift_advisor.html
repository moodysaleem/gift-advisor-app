<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Gift Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lottie player for the subtle animation -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Base Styling & Font */
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; }
        
        /* Interactive Card Styling */
        .card { 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }
        .card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.15); 
        }

        /* Choice Button Styling */
        .choice-btn {
            border: 2px solid #cbd5e1;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #4a5568;
            background-color: #ffffff;
        }
        .choice-btn:hover {
            border-color: #6366f1; /* Indigo-500 hover */
            background-color: #f0f5ff;
        }
        /* Active/Selected Button Styling */
        .choice-btn.active {
            background-color: #6366f1; /* Indigo-500 active */
            color: white;
            border-color: #6366f1;
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.4);
        }
        
        /* Loading Indicator */
        .loading-ring { 
            border: 4px solid rgba(255, 255, 255, 0.3); 
            border-top: 4px solid #ffffff; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            animation: spin 1s linear infinite; 
            display: inline-block; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Responsive Grid for Questions */
        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        /* Header Emoji Animation */
        .animated-emoji {
            display: inline-block;
            animation: bounce 2s infinite ease-in-out;
            transform-origin: bottom;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 bg-gray-50 flex justify-center">

    <div id="app" class="container max-w-5xl w-full bg-white shadow-2xl rounded-2xl p-6 md:p-12 border-t-4 border-indigo-500">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-indigo-700">
                The Gift Genie <span class="animated-emoji">üßû‚Äç‚ôÇÔ∏è</span>
            </h1>
            <p class="text-gray-600 mt-2 text-lg">Answer 5 simple questions for 5 personalized recommendations.</p>
        </header>

        <!-- Progress Bar -->
        <div id="progress-container" class="mb-8">
            <h2 id="progress-text" class="text-sm font-semibold text-indigo-700 mb-2">Progress: 0/5 Questions Answered</h2>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-indigo-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%;"></div>
            </div>
        </div>
        
        <div id="questionnaire" class="space-y-8">
            
            <div class="flex flex-col md:flex-row items-center justify-center bg-purple-50 p-4 rounded-lg shadow-inner mb-6">
                <!-- Smart, elegant figure animation -->
                <lottie-player 
                    src="https://lottie.host/85a6a611-3069-450f-a36c-9c748c03c51f/k3aA12hM67.json" 
                    background="transparent" 
                    speed="1" 
                    style="width: 100px; height: 100px;" 
                    loop autoplay
                    class="mr-4 mb-4 md:mb-0"
                ></lottie-player>
                <p class="text-lg font-semibold text-purple-800 text-center md:text-left">
                    Unleash the magic of AI to discover the perfect gift! ‚ú®
                </p>
            </div>

            <div class="p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-lg">
                <p class="text-sm text-indigo-700 font-medium">
                    Disclaimer: This tool uses AI to suggest gift ideas based on your input. All links are dynamic search links and contain your provided **Amazon Affiliate tag**.
                </p>
            </div>

            <!-- Q1: Recipient (MANDATORY) -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">1. Who is the gift for?</h2>
            <div class="question-grid" data-key="Recipient">
                <button data-answer="Family Member" class="choice-btn p-4 rounded-xl shadow-sm">Family Member</button>
                <button data-answer="Close Friend" class="choice-btn p-4 rounded-xl shadow-sm">Close Friend</button>
                <button data-answer="Coworker/Acquaintance" class="choice-btn p-4 rounded-xl shadow-sm">Coworker/Acquaintance</button>
                <button data-answer="Partner/Spouse" class="choice-btn p-4 rounded-xl shadow-sm">Partner/Spouse</button>
            </div>
            
            <!-- Q2: Budget (MANDATORY) -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">2. What is your approximate budget?</h2>
            <div class="question-grid" data-key="Budget">
                <button data-answer="Under $25" class="choice-btn p-4 rounded-xl shadow-sm">Under $25</button>
                <button data-answer="$25 - $75" class="choice-btn p-4 rounded-xl shadow-sm">$25 - $75</button>
                <button data-answer="Over $75" class="choice-btn p-4 rounded-xl shadow-sm">Over $75</button>
            </div>

            <!-- Q3: Age (MANDATORY) -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">3. What is the recipient's approximate age group?</h2>
            <div class="question-grid" data-key="Age">
                <button data-answer="Child (under 13)" class="choice-btn p-4 rounded-xl shadow-sm">Child (under 13)</button>
                <button data-answer="Teen (13-19)" class="choice-btn p-4 rounded-xl shadow-sm">Teen (13-19)</button>
                <button data-answer="Adult (20-55)" class="choice-btn p-4 rounded-xl shadow-sm">Adult (20-55)</button>
                <button data-answer="Senior (55+)" class="choice-btn p-4 rounded-xl shadow-sm">Senior (55+)</button>
            </div>

            <!-- Q4: Occasion (MANDATORY) -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">4. What is the occasion?</h2>
            <div class="question-grid" data-key="Occasion">
                <button data-answer="Birthday" class="choice-btn p-4 rounded-xl shadow-sm">Birthday</button>
                <button data-answer="Holiday/Christmas" class="choice-btn p-4 rounded-xl shadow-sm">Holiday/Christmas</button>
                <button data-answer="Anniversary/Milestone" class="choice-btn p-4 rounded-xl shadow-sm">Anniversary/Milestone</button>
                <button data-answer="Just Because/Thank You" class="choice-btn p-4 rounded-xl shadow-sm">Just Because/Thank You</button>
            </div>

            <!-- Q5: Timeline (MANDATORY) -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">5. How quickly do you need this gift?</h2>
            <div class="question-grid" data-key="Timeline">
                <button data-answer="Immediate (1-3 days)" class="choice-btn p-4 rounded-xl shadow-sm">Immediate (1-3 days)</button>
                <button data-answer="Standard (4-7 days)" class="choice-btn p-4 rounded-xl shadow-sm">Standard (4-7 days)</button>
                <button data-answer="Flexible (2+ weeks)" class="choice-btn p-4 rounded-xl shadow-sm">Flexible (2+ weeks)</button>
            </div>

            <!-- Submit Button -->
            <button id="submit-btn" disabled 
                    class="w-full text-lg md:text-xl p-4 mt-8 rounded-xl shadow-md transition duration-200 
                           bg-gray-400 text-gray-700 font-extrabold cursor-not-allowed">
                Answer 5 Mandatory Questions
            </button>
        </div>

        <!-- Results Section (Initially Hidden) -->
        <div id="results" class="hidden">
            <h2 class="text-3xl font-extrabold text-indigo-700 text-center mb-6">Your 5 Personalized Gift Ideas</h2>
            
            <p class="text-center text-gray-600 mb-8 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                You received **5 unique recommendations**. Click "View on Amazon" to search for the exact product described!
            </p>
            
            <div id="gift-cards-container" class="space-y-6 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-6 md:space-y-0">
                <!-- Gift cards will be inserted here -->
            </div>

            <!-- Run Again Button -->
            <div class="mt-10 text-center">
                <button id="restart-btn" 
                        class="text-lg py-3 px-8 rounded-xl shadow-md bg-indigo-500 text-white font-bold 
                               hover:bg-indigo-600 transition duration-200">
                    Find a Gift for Another Person üîÑ
                </button>
            </div>
        </div>

        <!-- Error/Loading Messages -->
        <div id="message-area" class="mt-8 text-center hidden">
            <p id="error-message" class="text-red-500 font-semibold hidden"></p>
            <div id="loading-spinner" class="hidden">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-3 text-indigo-600 font-semibold">Generating 5 personalized gift ideas now...</p>
            </div>
        </div>

    </div>

    <script type="module">
        // ----------------------------------------------------------------------
        // CRITICAL CONFIGURATION SECTION
        // ----------------------------------------------------------------------
        
        // 1. GEMINI API KEY: This is the source of the 403 Forbidden error.
        // YOU MUST REPLACE THE EMPTY STRING WITH YOUR ACTUAL GEMINI API KEY.
        const apiKey = "AIzaSyBGKVEl84vEUIwHYcHewWA_YUKgrJbyamg"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        // 2. AMAZON AFFILIATE TAG: This is your unique ID for commission.
        // The URL will look like amazon.com/s?k=ProductName&tag=giftwithai-21
        const affiliateTag = "giftwithai-21"; 

        // 3. MANDATORY QUESTION DEFINITIONS
        // Defines which questions must be answered before submission is enabled.
        // NOTE: The 'Interest' question has been removed from the HTML.
        const mandatoryKeys = ['Recipient', 'Budget', 'Age', 'Occasion', 'Timeline'];
        const totalMandatory = mandatoryKeys.length; // This is now 5

        // ----------------------------------------------------------------------
        // STATE AND ELEMENTS
        // ----------------------------------------------------------------------
        const selectedAnswers = {};
        const state = { currentAnswers: 0 };
        
        const appElement = document.getElementById('app');
        const questionnaireElement = document.getElementById('questionnaire');
        const resultsElement = document.getElementById('results');
        const submitBtn = document.getElementById('submit-btn');
        const restartBtn = document.getElementById('restart-btn');
        const cardsContainer = document.getElementById('gift-cards-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMsg = document.getElementById('error-message');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        // ----------------------------------------------------------------------
        // UTILITY FUNCTIONS
        // ----------------------------------------------------------------------

        /**
         * Generates the dynamic Amazon affiliate search link.
         * @param {string} productName The name of the product returned by the AI.
         * @returns {string} The complete affiliate search URL.
         */
        function generateAffiliateLink(productName) {
            const encodedName = encodeURIComponent(productName);
            // Uses the standard search structure for maximum relevance
            return `https://www.amazon.com/s?k=${encodedName}&tag=${affiliateTag}`;
        }

        /**
         * Maps the budget string to a specific, detailed prompt instruction.
         * @param {string} budget The budget selected by the user.
         * @returns {string} Detailed instruction for the AI.
         */
        function mapBudgetToPrompt(budget) {
            switch (budget) {
                case 'Under $25':
                    return 'PRIORITIZE gifts likely found in the $10 to $25 range. Use small, thoughtful ideas.';
                case '$25 - $75':
                    return 'PRIORITIZE mid-range products priced between $30 to $70. Focus on quality items.';
                case 'Over $75':
                    return 'PRIORITIZE high-end or large gift bundles priced between $80 to $150. Focus on premium items.';
                default:
                    return '';
            }
        }

        /**
         * Updates the UI to show the current progress through mandatory questions.
         */
        function updateProgressBar() {
            // Checks how many of the 5 mandatory keys have answers
            const answeredMandatory = mandatoryKeys.filter(key => selectedAnswers[key]).length;
            const percentage = (answeredMandatory / totalMandatory) * 100;

            state.currentAnswers = answeredMandatory;
            progressText.textContent = `Progress: ${answeredMandatory}/${totalMandatory} Questions Answered`;
            progressBar.style.width = `${percentage}%`;
        }
        
        /**
         * Checks if all mandatory questions have been answered and updates the button.
         */
        function checkReady() {
            updateProgressBar();

            if (state.currentAnswers === totalMandatory) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-400', 'text-gray-700', 'cursor-not-allowed');
                submitBtn.classList.add('bg-yellow-500', 'text-indigo-900', 'hover:bg-yellow-600');
                submitBtn.textContent = 'Generate 5 Gift Ideas!';
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-gray-400', 'text-gray-700', 'cursor-not-allowed');
                submitBtn.classList.remove('bg-yellow-500', 'text-indigo-900', 'hover:bg-yellow-600');
                submitBtn.textContent = `Answer ${totalMandatory - state.currentAnswers} Mandatory Questions`;
            }
        }

        /**
         * Handles user clicking a choice button.
         * @param {HTMLElement} btn The button element clicked.
         */
        function handleChoice(btn) {
            const key = btn.parentElement.dataset.key;
            const answer = btn.dataset.answer;

            // Clear previous active state for this question
            btn.parentElement.querySelectorAll('.choice-btn').forEach(b => {
                b.classList.remove('active');
            });

            // Set active state for the clicked button
            btn.classList.add('active');

            // Save the answer
            selectedAnswers[key] = answer;
            
            checkReady();
        }

        /**
         * Builds the structured JSON request payload for the Gemini API.
         * @returns {object} The complete payload.
         */
        function buildPayload() {
            const budgetPrompt = selectedAnswers.Budget ? mapBudgetToPrompt(selectedAnswers.Budget) : '';
            // Interest is now optional, check if it was answered
            const interest = selectedAnswers.Interest && selectedAnswers.Interest !== 'None/General' ? `Their primary interest is ${selectedAnswers.Interest}.` : '';

            // System Instruction to guide the model's tone and persona
            const systemPrompt = "You are a creative, expert gift advisor. Your goal is to generate 5 distinct, high-quality, product-focused gift recommendations that perfectly match the user's criteria. Be compelling, concise, and highly specific in your product name and description.";

            const userQuery = `The gift recipient is a ${selectedAnswers.Age} ${selectedAnswers.Recipient}. The gift is for a ${selectedAnswers.Occasion}. The user needs the gift ${selectedAnswers.Timeline}. ${interest} ${budgetPrompt} Generate 5 distinct, high-quality gift recommendations and provide a detailed visual search term for each product so an image can be found.`;

            // Schema to force the model to return 5 structured JSON objects
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "productName": { "type": "STRING", "description": "A creative, concise name for the product idea (e.g., 'The Smart Brew Coffee Mug')." },
                                "description": { "type": "STRING", "description": "A brief, compelling description (2-3 sentences max) tailored to the recipient's criteria." },
                                "category": { "type": "STRING", "description": "The general product category (e.g., Home Goods, Tech, Apparel)." },
                                "searchImageUrl": { "type": "STRING", "description": "A highly specific, visual search term (e.g., 'Sleek matte black smart coffee mug with wooden handle') suitable for an image search engine." },
                            },
                            required: ["productName", "description", "category", "searchImageUrl"]
                        }
                    }
                }
            };
            return payload;
        }

        /**
         * Renders the 5 gift ideas onto the page as cards.
         * @param {Array<object>} gifts The array of gift objects from the API.
         */
        function renderGifts(gifts) {
            cardsContainer.innerHTML = '';
            
            gifts.forEach(gift => {
                const productName = gift.productName || 'Thoughtful Gift Idea';
                const description = gift.description || 'A unique and personalized item perfect for the occasion.';
                const category = gift.category || 'General';
                const searchImageUrl = gift.searchImageUrl || productName; // Use product name if visual term is missing

                // Create the dynamic Amazon Search Link
                const affiliateLink = generateAffiliateLink(productName);
                
                // Create a placeholder image URL using the visual search term for high relevance
                const placeholderText = searchImageUrl.substring(0, 30);
                const placeholderImageUrl = `https://placehold.co/400x250/6366f1/ffffff?text=${encodeURIComponent(placeholderText.split(' ').join('+'))}`;

                const cardHtml = `
                    <div class="card p-6 rounded-2xl shadow-lg flex flex-col space-y-4">
                        <img src="${placeholderImageUrl}" alt="${productName}" class="w-full h-auto rounded-xl object-cover border border-gray-100">
                        <div class="flex-grow">
                            <span class="text-sm font-medium text-indigo-500 bg-indigo-50 px-3 py-1 rounded-full">${category}</span>
                            <h3 class="text-2xl font-bold text-gray-800 mt-2">${productName}</h3>
                            <p class="text-gray-600 mt-2">${description}</p>
                        </div>
                        <a 
                            href="${affiliateLink}" 
                            target="_blank" 
                            class="mt-auto block text-center py-3 px-6 bg-yellow-500 text-indigo-900 font-extrabold rounded-xl shadow-md hover:bg-yellow-600 transition duration-150 transform hover:scale-[1.01]"
                        >
                            View on Amazon ‚ÜóÔ∏è
                        </a>
                    </div>
                `;
                cardsContainer.innerHTML += cardHtml;
            });
        }

        /**
         * Main function to call the Gemini API.
         */
        async function getRecommendations() {
            // Check for API Key (prevents unnecessary failed requests)
            if (!apiKey || apiKey === "YOUR_KEY_HERE" || apiKey.length < 5) {
                console.error("API Key is missing or invalid. Please insert your key into the code.");
                errorMsg.textContent = "Error: API key is missing (403 Forbidden). Please insert your key on GitHub and commit.";
                errorMsg.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                return;
            }
            
            // Hide questionnaire, show loading
            questionnaireElement.classList.add('hidden');
            resultsElement.classList.add('hidden');
            document.getElementById('message-area').classList.remove('hidden');
            errorMsg.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            const payload = buildPayload();
            let attempts = 0;
            const maxAttempts = 3;
            let result = null;

            while (attempts < maxAttempts) {
                attempts++;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 403) {
                            throw new Error(`API request failed with status: 403 Forbidden. Check your API key and billing status.`);
                        }
                        throw new Error(`API request failed with status: ${response.status}`);
                    }

                    const jsonResponse = await response.json();
                    
                    if (jsonResponse.candidates && jsonResponse.candidates.length > 0) {
                        const contentText = jsonResponse.candidates[0].content.parts[0].text.trim();
                        // The structured output is returned as a string, must be parsed
                        result = JSON.parse(contentText);
                        break; // Success! Exit the retry loop.
                    }
                } catch (error) {
                    console.error(`Attempt ${attempts} failed:`, error.message);
                    if (error.message.includes('403')) {
                        // Critical error, do not retry
                        errorMsg.textContent = `API request failed with status: 403 Forbidden. Please verify your Gemini API key and billing status.`;
                        errorMsg.classList.remove('hidden');
                        loadingSpinner.classList.add('hidden');
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 2000 * attempts)); // Exponential backoff
                }
            }

            loadingSpinner.classList.add('hidden');
            
            if (result && Array.isArray(result) && result.length > 0) {
                renderGifts(result);
                resultsElement.classList.remove('hidden');
                document.getElementById('message-area').classList.add('hidden');

                // Scroll to the results
                resultsElement.scrollIntoView({ behavior: 'smooth' });

            } else {
                errorMsg.textContent = "Failed to get recommendations after multiple attempts. Please try again later.";
                errorMsg.classList.remove('hidden');
            }
        }

        // ----------------------------------------------------------------------
        // EVENT LISTENERS
        // ----------------------------------------------------------------------
        
        // Listener for all choice buttons
        questionnaireElement.addEventListener('click', (event) => {
            const btn = event.target.closest('.choice-btn');
            if (btn) {
                handleChoice(btn);
            }
        });

        // Listener for the submit button
        submitBtn.addEventListener('click', getRecommendations);

        // Listener for the restart button
        restartBtn.addEventListener('click', () => {
            // Clear selections
            Object.keys(selectedAnswers).forEach(key => delete selectedAnswers[key]);
            
            // Reset UI
            questionnaireElement.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('active'));
            resultsElement.classList.add('hidden');
            questionnaireElement.classList.remove('hidden');
            document.getElementById('message-area').classList.add('hidden');
            
            // Reset state
            checkReady();
            
            // Scroll to the top
            appElement.scrollIntoView({ behavior: 'smooth' });
        });

        // Initial check when the page loads
        checkReady();

    </script>
</body>
</html>
