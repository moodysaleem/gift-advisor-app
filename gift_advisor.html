<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gift with AI — Gift Advisor</title>

  <!-- Google Tag Manager (head) - GTM container inserted as requested -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-T8TBW4QT');</script>
  <!-- End Google Tag Manager (head) -->

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Small styles for banner and product cards */
    #catalogBanner {
      background:#fff3cd;
      color:#6a4f00;
      border:1px solid #f0c36d;
      padding:8px 12px;
      margin:12px 0;
      border-radius:4px;
      font-size:14px;
    }
    .product { margin:10px 0; padding:10px; border:1px solid #eee; border-radius:6px; display:flex; gap:12px; align-items:center; }
    .product img { width:84px; height:52px; object-fit:cover; border-radius:4px; }
    .product .meta { flex:1; }
    .product .meta .title { font-weight:600; }
    .affiliate-link { color:#0b66c3; text-decoration:none; }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8TBW4QT"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <main>
    <!-- Informational banner (small, non-intrusive) -->
    <div id="catalogBanner">Suggestions generated from our catalog — enrichment disabled.</div>

    <!-- Example inputs (your real form may differ) -->
    <section id="advisorForm">
      <!-- Replace or extend these inputs to match your existing UI -->
      <label>Recipient:
        <select id="recipient">
          <option>Family Member</option>
          <option>Friend</option>
          <option>Co-worker</option>
        </select>
      </label>
      <label>Budget:
        <select id="budget">
          <option>Under $25</option>
          <option>$25–$50</option>
          <option>$50+</option>
        </select>
      </label>
      <button id="generateBtn">Generate</button>
    </section>

    <!-- Results container where product links are rendered -->
    <div id="results" aria-live="polite"></div>
  </main>

  <script>
    // Ensure dataLayer exists for GTM
    window.dataLayer = window.dataLayer || [];

    // Helper to collect answers from the simple form above.
    // Replace this with your real form data collection.
    function collectAnswers() {
      return {
        Recipient: document.getElementById('recipient')?.value || '',
        Budget: document.getElementById('budget')?.value || '',
        // add other fields as needed (Gender, Age, Occasion, Timeline, interests...)
      };
    }

    // Call your worker and push a 'generate' event for GTM
    async function generateRecommendations() {
      const answers = collectAnswers();
      const numRecommendations = 3;

      // Push generate event to dataLayer so GTM can capture it
      window.dataLayer.push({
        event: 'generate',
        answers: answers,
        numRecommendations: numRecommendations
      });

      // Fetch recommendations from your worker
      try {
        const resp = await fetch('https://bold-lake-a224.moodysaleem.workers.dev/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers, interests: [], numRecommendations })
        });

        if (!resp.ok) throw new Error('Network response not OK');

        const data = await resp.json();
        renderResults(data.items || []);
      } catch (err) {
        console.error('Recommendation fetch failed', err);
        document.getElementById('results').innerText = 'Sorry — could not fetch recommendations.';
      }
    }

    // Render results into the page and create affiliate links
    function renderResults(items) {
      const container = document.getElementById('results');
      container.innerHTML = '';
      if (!items.length) {
        container.textContent = 'No suggestions found.';
        return;
      }

      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'product';

        const img = document.createElement('img');
        img.src = item.image || 'https://placehold.co/400x250?text=No+image';
        img.alt = item.productName || 'Product image';
        card.appendChild(img);

        const meta = document.createElement('div');
        meta.className = 'meta';

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = item.productName || 'Untitled product';
        meta.appendChild(title);

        const desc = document.createElement('div');
        desc.className = 'desc';
        desc.textContent = item.description || '';
        meta.appendChild(desc);

        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = item.price || '';
        meta.appendChild(price);

        card.appendChild(meta);

        // Affiliate link
        const a = document.createElement('a');
        a.href = item.affiliateUrl || '#';
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'affiliate-link';
        // Ensure product name is available for tracking
        a.dataset.productName = item.productName || '';
        a.textContent = 'View on Amazon';
        card.appendChild(a);

        container.appendChild(card);
      });
    }

    // Delegated click handler for affiliate links to push affiliate_click events.
    // We attempt to record the click with a short delay before opening the link,
    // which helps GTM register the event reliably.
    document.addEventListener('click', function (e) {
      const el = e.target.closest && e.target.closest('a.affiliate-link');
      if (!el) return;

      // Prevent default navigation to allow event to be pushed.
      e.preventDefault();

      const href = el.href;
      const productName = el.dataset.productName || '';

      window.dataLayer.push({
        event: 'affiliate_click',
        productName: productName,
        affiliateUrl: href
      });

      // Small delay so GTM has time to process the push. Adjust if needed.
      setTimeout(() => {
        // Open in a new tab/window (same as target="_blank")
        window.open(href, '_blank', 'noopener,noreferrer');
      }, 150);
    });

    // Wire up Generate button
    document.getElementById('generateBtn').addEventListener('click', function (evt) {
      evt.preventDefault();
      generateRecommendations();
    });

    // Optionally, fire a small pageview-like event for GTM on load (GTM can also do this via its config)
    window.dataLayer.push({ event: 'gift_advisor_pageview' });
  </script>
</body>
</html>
