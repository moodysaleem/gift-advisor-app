<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Gift Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use a modern, clean font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    

<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        /* Base Styling & Font */
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; }
        
        /* Interactive Card Styling */
        .card { 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }
        .card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.15); 
        }

        /* Choice Button Styling */
        .choice-btn {
            border: 2px solid #cbd5e1;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #4a5568;
            background-color: #ffffff;
        }
        .choice-btn:hover {
            border-color: #6366f1; /* Indigo-500 hover */
            background-color: #f0f5ff;
        }
        /* Active/Selected Button Styling */
        .choice-btn.active {
            background-color: #6366f1; /* Indigo-500 active */
            color: white;
            border-color: #6366f1;
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.4);
        }
        
        /* Loading Indicator */
        .loading-ring { 
            border: 4px solid rgba(255, 255, 255, 0.3); 
            border-top: 4px solid #ffffff; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            animation: spin 1s linear infinite; 
            display: inline-block; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Responsive Grid for Questions */
        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        /* Header Emoji Animation */
        .animated-emoji {
            display: inline-block;
            animation: bounce 2s infinite ease-in-out;
            transform-origin: bottom;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 bg-gray-50 flex justify-center">

    <div id="app" class="container max-w-5xl w-full bg-white shadow-2xl rounded-2xl p-6 md:p-12 border-t-4 border-indigo-500">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-indigo-700">
                The Gift Genie <span class="animated-emoji">üßû‚Äç‚ôÇÔ∏è</span>
            </h1>
            <p class="text-gray-600 mt-2 text-lg">Answer a few simple questions for personalized recommendations.</p>
        </header>

        <!-- Questionnaire Section -->
        <div id="questionnaire" class="space-y-8">
            
            <div class="flex flex-col md:flex-row items-center justify-center bg-purple-50 p-4 rounded-lg shadow-inner mb-6">
                <!-- Lottie Animation for visual appeal -->
                <lottie-player 
                    src="https://lottie.host/85a6a611-3069-450f-a36c-9c748c03c51f/k3aA12hM67.json" 
                    background="transparent" 
                    speed="1" 
                    style="width: 100px; height: 100px;" 
                    loop autoplay
                    class="mr-4 mb-4 md:mb-0"
                ></lottie-player>
                <p class="text-lg font-semibold text-purple-800 text-center md:text-left">
                    Unleash the magic of AI to discover the perfect gift! ‚ú®
                </p>
            </div>

            <div class="p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-lg">
                <p class="text-sm text-indigo-700 font-medium">
                    Disclaimer: This tool uses AI to suggest gift ideas based on your input. Product availability and pricing are estimated. All links contain your provided **Amazon Affiliate tag**.
                </p>
            </div>

            <!-- Question 1 -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">1. Who is the gift for?</h2>
            <div class="question-grid">
                <button data-answer="Recipient: Family Member" class="choice-btn p-4 rounded-xl shadow-sm">Family Member</button>
                <button data-answer="Recipient: Close Friend" class="choice-btn p-4 rounded-xl shadow-sm">Close Friend</button>
                <button data-answer="Recipient: Coworker/Acquaintance" class="choice-btn p-4 rounded-xl shadow-sm">Coworker/Acquaintance</button>
                <button data-answer="Recipient: Partner/Spouse" class="choice-btn p-4 rounded-xl shadow-sm">Partner/Spouse</button>
            </div>
            
            <!-- Question 2 -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">2. What is their main interest or hobby?</h2>
            <div class="question-grid">
                <button data-answer="Interest: Cooking/Gourmet Food" class="choice-btn p-4 rounded-xl shadow-sm">Cooking/Food</button>
                <button data-answer="Interest: Technology/Gaming" class="choice-btn p-4 rounded-xl shadow-sm">Tech/Gaming</button>
                <button data-answer="Interest: Outdoors/Fitness" class="choice-btn p-4 rounded-xl shadow-sm">Outdoors/Fitness</button>
                <button data-answer="Interest: Home Decor/Art" class="choice-btn p-4 rounded-xl shadow-sm">Home Decor/Art</button>
            </div>

            <!-- Question 3 -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">3. What is your approximate budget?</h2>
            <div class="question-grid">
                <button data-answer="Budget: Under $25" class="choice-btn p-4 rounded-xl shadow-sm">Under $25</button>
                <button data-answer="Budget: $25 - $75" class="choice-btn p-4 rounded-xl shadow-sm">$25 - $75</button>
                <button data-answer="Budget: Over $75" class="choice-btn p-4 rounded-xl shadow-sm">Over $75</button>
            </div>

            <!-- Question 4 -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">4. What is the recipient's approximate age group?</h2>
            <div class="question-grid">
                <button data-answer="Age: Child (under 13)" class="choice-btn p-4 rounded-xl shadow-sm">Child (under 13)</button>
                <button data-answer="Age: Teen (13-19)" class="choice-btn p-4 rounded-xl shadow-sm">Teen (13-19)</button>
                <button data-answer="Age: Adult (20-60)" class="choice-btn p-4 rounded-xl shadow-sm">Adult (20-60)</button>
                <button data-answer="Age: Senior (60+)" class="choice-btn p-4 rounded-xl shadow-sm">Senior (60+)</button>
            </div>

            <!-- Question 5 -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">5. What is the occasion for the gift?</h2>
            <div class="question-grid">
                <button data-answer="Occasion: Birthday" class="choice-btn p-4 rounded-xl shadow-sm">Birthday</button>
                <button data-answer="Occasion: Holiday (Christmas/Kwanzaa/etc.)" class="choice-btn p-4 rounded-xl shadow-sm">Holiday</button>
                <button data-answer="Occasion: Housewarming/Host Gift" class="choice-btn p-4 rounded-xl shadow-sm">Housewarming/Host</button>
                <button data-answer="Occasion: Just Because" class="choice-btn p-4 rounded-xl shadow-sm">Just Because</button>
            </div>
            
            <!-- Question 6 -->
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200">6. How urgently is the gift needed (delivery timeline)?</h2>
            <div class="question-grid">
                <button data-answer="Timeline: Immediate (Digital/Quick Ship)" class="choice-btn p-4 rounded-xl shadow-sm">Immediate (1-3 Days)</button>
                <button data-answer="Timeline: Standard (Up to 14 days)" class="choice-btn p-4 rounded-xl shadow-sm">Standard (Up to 14)</button>
                <button data-answer="Timeline: Flexible (Up to 30+ days)" class="choice-btn p-4 rounded-xl shadow-sm">Flexible (30+ Days)</button>
            </div>

            <div class="pt-8">
                <button id="submit-btn" class="w-full py-4 px-6 bg-gray-400 text-white font-extrabold text-lg rounded-xl shadow-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-green-400 flex items-center justify-center" disabled>
                    <span id="submit-text">Answer all 6 questions to get suggestions (0/6)</span>
                    <span id="loading-indicator" class="hidden loading-ring ml-3"></span>
                </button>
            </div>
        </div>

        <!-- Results Section (Hidden until submitted) -->
        <div id="results" class="hidden">
            <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Your AI-Powered Gift Ideas</h2>
            <p class="text-center text-gray-600 mb-8">Based on your answers, here are 3 personalized gift suggestions:</p>

            <div id="gift-grid" class="gift-grid grid md:grid-cols-3 gap-6">
                <!-- Gift cards will be injected here -->
            </div>

            <div class="mt-10 flex justify-center">
                <button onclick="resetApp()" class="py-3 px-6 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-150 shadow-md">
                    Start Over
                </button>
            </div>
        </div>
        
        <!-- Error/Message Box -->
        <div id="message-box" class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>

    </div>

    <script type="module">
        const apiKey = ""; // Canvas provides the Gemini API key securely at runtime
        const affiliateTag = "giftwithai-21"; // Your confirmed Amazon Associate Tag!
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // UI Elements
        const questionnaireDiv = document.getElementById('questionnaire');
        const resultsDiv = document.getElementById('results');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const giftGrid = document.getElementById('gift-grid');
        const messageBox = document.getElementById('message-box');

        // State Management
        let userAnswers = {};
        const totalQuestions = 6;

        // JSON Schema for structured output
        const responseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "productName": { 
                        "type": "STRING", 
                        "description": "The name of the recommended Amazon product." 
                    },
                    "description": { 
                        "type": "STRING", 
                        "description": "A concise, engaging 1-2 sentence description explaining why this is the perfect gift, suitable for a gift card." 
                    },
                    "category": { 
                        "type": "STRING", 
                        "description": "A broad category for the gift (e.g., 'Kitchen Gadget', 'Outdoor Gear', 'Tech Accessory')." 
                    },
                    // We instruct the model to provide a mock ASIN and link, as it cannot look up real products.
                    "mockASIN": {
                        "type": "STRING",
                        "description": "A placeholder ASIN (10-digit code like 'B07KW4X5J1') that will be used to construct the Amazon link."
                    }
                },
                required: ["productName", "description", "category", "mockASIN"]
            }
        };

        // --- Core Functions ---

        /**
         * Converts the user answers into a structured prompt for the Gemini API.
         * @returns {string} The formatted prompt string.
         */
        function buildPrompt() {
            const recipient = userAnswers['Recipient'] || 'Someone special';
            const interest = userAnswers['Interest'] || 'various interests';
            const budget = userAnswers['Budget'] || 'medium';
            const age = userAnswers['Age'] || 'Adult';
            const occasion = userAnswers['Occasion'] || 'a general celebration';
            const timeline = userAnswers['Timeline'] || 'Standard delivery';


            const prompt = `Act as an expert gift recommendation agent. Based on the following user preferences, generate exactly 3 unique and creative gift ideas available on Amazon. For each idea, provide a product name, a compelling description for a gift card, a broad product category, and a placeholder 10-digit ASIN (Amazon Standard Item Number) starting with 'B'.

            User Preferences:
            1. Recipient Type: ${recipient}
            2. Main Interest: ${interest}
            3. Budget/Price Range: ${budget}
            4. Recipient Age: ${age}
            5. Occasion: ${occasion}
            6. Delivery Timeline: ${timeline}

            Ensure the response strictly follows the provided JSON schema. If the timeline is 'Immediate', prioritize digital, service, or quickly shipped gifts.`;
            
            return prompt;
        }

        /**
         * Generates the Amazon affiliate link using the placeholder ASIN and the user's tag.
         * @param {string} asin The Amazon product ID (ASIN).
         * @returns {string} The complete affiliate URL.
         */
        function generateAffiliateLink(asin) {
            // Standard Amazon affiliate link structure: /dp/[ASIN]/ref=nosim?tag=[YOUR_ASSOCIATE_ID]
            return `https://www.amazon.com/dp/${asin}/?tag=${affiliateTag}`;
        }

        /**
         * Shows a message box with an error or status.
         * @param {string} message The message to display.
         * @param {string} type The type of message ('error' or 'info').
         */
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `mt-6 p-4 rounded-lg text-center ${type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-green-100 border border-green-400 text-green-700'}`;
            messageBox.classList.remove('hidden');
        }

        /**
         * Renders the gift cards onto the results grid.
         * @param {Array<Object>} gifts An array of gift objects from the Gemini API.
         */
        function renderGifts(gifts) {
            giftGrid.innerHTML = ''; // Clear previous results
            
            gifts.forEach((gift, index) => {
                const asin = gift.mockASIN.replace(/[^A-Z0-9]/g, '').substring(0, 10); // Clean ASIN
                const affiliateLink = generateAffiliateLink(asin || 'B07KW4X5J1'); // Use fallback ASIN if needed
                
                // Note: The category is used in the placeholder image text.
                const categoryText = gift.category.replace(/[^a-zA-Z\s]/g, '').split(' ').slice(0, 2).join('+');
                
                const cardHtml = `
                    <div class="card bg-white p-5 rounded-xl shadow-lg flex flex-col justify-between transform hover:scale-[1.02] transition-transform duration-300">
                        <!-- Placeholder Image (Since we cannot search Amazon for a real one) -->
                        <img 
                            src="https://placehold.co/300x180/EBF5FF/2B6CB0?text=${categoryText}" 
                            alt="${gift.productName}" 
                            onerror="this.onerror=null;this.src='https://placehold.co/300x180/D1D5DB/4B5563?text=Gift';"
                            class="w-full h-auto object-cover rounded-xl mb-4 border border-gray-200"
                        >

                        <h3 class="text-xl font-extrabold text-gray-800 mb-1">${gift.productName}</h3>
                        <p class="text-sm text-indigo-600 font-semibold mb-3">${gift.category}</p>
                        <p class="text-gray-500 text-sm mb-4 flex-grow">${gift.description}</p>
                        
                        <a 
                            href="${affiliateLink}" 
                            target="_blank" 
                            class="mt-auto block text-center py-3 px-4 bg-yellow-400 text-gray-900 font-bold rounded-xl hover:bg-yellow-500 transition duration-150 shadow-md text-base"
                        >
                            View on Amazon ‚ÜóÔ∏è
                        </a>
                    </div>
                `;
                giftGrid.insertAdjacentHTML('beforeend', cardHtml);
            });
            
            questionnaireDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
        }

        /**
         * Fetches gift recommendations from the Gemini API.
         */
        async function fetchRecommendations() {
            loadingIndicator.classList.remove('hidden');
            submitText.textContent = 'Generating ideas...';
            submitBtn.disabled = true;
            submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitBtn.classList.add('bg-indigo-500'); // Transition to an active color
            messageBox.classList.add('hidden');
            
            const userPrompt = buildPrompt();

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                },
                // Use a system instruction to fully define the model's persona
                systemInstruction: {
                    parts: [{ text: "You are a specialized AI Gift Advisor that recommends exactly 3 products available on Amazon. You must adhere strictly to the provided JSON schema." }]
                }
            };

            // Simple retry mechanism 
            for (let i = 0; i < 3; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) {
                        throw new Error("API response was missing expected JSON text.");
                    }

                    const gifts = JSON.parse(jsonText);
                    
                    if (Array.isArray(gifts) && gifts.length === 3) {
                        renderGifts(gifts);
                        return; // Success
                    } else {
                         throw new Error("Model returned malformed data or not exactly 3 items.");
                    }

                } catch (error) {
                    console.error("Attempt failed:", error.message);
                    if (i === 2) {
                        showMessage(`Failed to get recommendations after multiple attempts. Error: ${error.message}. Please try again later.`);
                    }
                    // Wait 2 seconds before retrying
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            // If function reaches here, all attempts failed
            loadingIndicator.classList.add('hidden');
            submitText.textContent = 'Submit';
            submitBtn.classList.remove('bg-indigo-500');
            submitBtn.classList.add('bg-gray-400');
            submitBtn.disabled = false;
        }

        // --- UI Event Handlers ---

        /**
         * Handles the selection of a choice button.
         * @param {Event} e The click event.
         */
        function handleChoice(e) {
            const button = e.currentTarget;
            const answer = button.getAttribute('data-answer');
            const [key, value] = answer.split(': ');
            
            // Deselect all buttons for this question group
            document.querySelectorAll(`button[data-answer*='${key}:']`).forEach(btn => {
                btn.classList.remove('active');
            });

            // Select the clicked button
            button.classList.add('active');

            // Update state
            userAnswers[key] = value;
            
            // Check readiness
            checkReady();
        }
        
        /**
         * Checks if all questions have been answered to enable the submit button.
         */
        function checkReady() {
            const answeredQuestions = Object.keys(userAnswers).length;
            if (answeredQuestions === totalQuestions) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-400');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                submitText.textContent = 'Get My Gift Ideas!';
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-gray-400');
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitText.textContent = `Answer all ${totalQuestions} questions to get suggestions (${answeredQuestions}/${totalQuestions})`;
            }
        }

        /**
         * Resets the application state and UI.
         */
        window.resetApp = function() {
            userAnswers = {};
            // Deselect all buttons
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            resultsDiv.classList.add('hidden');
            questionnaireDiv.classList.remove('hidden');
            messageBox.classList.add('hidden');
            checkReady();
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Attach event listeners to all choice buttons
            document.querySelectorAll('.choice-btn').forEach(button => {
                button.addEventListener('click', handleChoice);
            });
            
            // Attach event listener to the main submit button
            submitBtn.addEventListener('click', fetchRecommendations);

            checkReady(); // Initial check
        });
    </script>
</body>
</html>