<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gift with AI — Gift Advisor</title>

  <!-- Google Tag Manager (head) - container GTM-T8TBW4QT -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-T8TBW4QT');</script>
  <!-- End Google Tag Manager (head) -->

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:18px; color:#111; }
    #catalogBanner {
      background:#fff3cd;
      color:#6a4f00;
      border:1px solid #f0c36d;
      padding:8px 12px;
      margin:12px 0;
      border-radius:4px;
      font-size:14px;
    }
    #advisorForm { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:12px; }
    #advisorForm label { display:flex; flex-direction:column; font-size:14px; }
    #generateBtn { padding:8px 14px; font-size:15px; cursor:pointer; }
    #results { margin-top:16px; }
    .product { margin:10px 0; padding:10px; border:1px solid #eee; border-radius:6px; display:flex; gap:12px; align-items:center; }
    .product img { width:84px; height:52px; object-fit:cover; border-radius:4px; flex:0 0 84px; }
    .product .meta { flex:1; }
    .product .meta .title { font-weight:600; margin-bottom:6px; }
    .affiliate-link { color:#0b66c3; text-decoration:none; display:inline-block; margin-top:6px; }
    .note { color:#666; font-size:13px; margin-top:6px; }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8TBW4QT"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <main>
    <div id="catalogBanner">Suggestions generated from our catalog — enrichment disabled.</div>

    <!-- Main form (fields match the worker test fields) -->
    <section id="advisorForm">
      <label>Recipient:
        <select id="recipient" name="Recipient">
          <option>Family Member</option>
          <option>Friend</option>
          <option>Co-worker</option>
          <option>Partner</option>
        </select>
      </label>

      <label>Gender:
        <select id="gender" name="Gender">
          <option>Any/Generic</option>
          <option>Male</option>
          <option>Female</option>
          <option>Non-binary</option>
        </select>
      </label>

      <label>Budget:
        <select id="budget" name="Budget">
          <option>Under $25</option>
          <option>$25–$50</option>
          <option>$50–$100</option>
          <option>$100+</option>
        </select>
      </label>

      <label>Age:
        <select id="age" name="Age">
          <option>Adult (20-55)</option>
          <option>Young Adult (18-25)</option>
          <option>Senior (55+)</option>
          <option>Teen (13-19)</option>
        </select>
      </label>

      <label>Occasion:
        <select id="occasion" name="Occasion">
          <option>Birthday</option>
          <option>Holiday</option>
          <option>Anniversary</option>
          <option>Just Because</option>
        </select>
      </label>

      <label>Timeline:
        <select id="timeline" name="Timeline">
          <option>Immediate (1-3)</option>
          <option>1 week</option>
          <option>2+ weeks</option>
        </select>
      </label>

      <button id="generateBtn">Generate</button>
    </section>

    <div id="results" aria-live="polite"></div>
    <div class="note">If results show encoding artifacts (â, âkeeps, etc.), convert your catalog CSV to UTF-8 and clean the text.</div>
  </main>

  <script>
    // Ensure dataLayer exists for GTM
    window.dataLayer = window.dataLayer || [];

    // Helper to collect answers from the form fields (keeps same keys as worker expects)
    function collectAnswers() {
      return {
        Recipient: document.getElementById('recipient')?.value || '',
        Gender: document.getElementById('gender')?.value || '',
        Budget: document.getElementById('budget')?.value || '',
        Age: document.getElementById('age')?.value || '',
        Occasion: document.getElementById('occasion')?.value || '',
        Timeline: document.getElementById('timeline')?.value || ''
      };
    }

    // Call the worker and push a 'generate' event for GTM
    async function generateRecommendations() {
      const answers = collectAnswers();
      const numRecommendations = 3;

      // Push generate event to dataLayer for GTM tracking
      window.dataLayer.push({
        event: 'generate',
        answers: answers,
        numRecommendations: numRecommendations
      });

      // Show a small loading state
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = '<div class="note">Loading suggestions…</div>';

      // POST to the existing worker (keeps your existing worker URL)
      try {
        const resp = await fetch('https://bold-lake-a224.moodysaleem.workers.dev/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers, interests: [], numRecommendations })
        });

        if (!resp.ok) throw new Error('Network response not OK: ' + resp.status);

        const data = await resp.json();
        renderResults(data.items || []);
      } catch (err) {
        console.error('Recommendation fetch failed', err);
        resultsEl.innerHTML = '<div class="note">Sorry — could not fetch recommendations right now.</div>';
      }
    }

    // Render product results and attach affiliate links
    function renderResults(items) {
      const container = document.getElementById('results');
      container.innerHTML = '';
      if (!items.length) {
        container.textContent = 'No suggestions found.';
        return;
      }

      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'product';

        const img = document.createElement('img');
        img.src = item.image || 'https://placehold.co/400x250?text=No+image';
        img.alt = item.productName || 'Product image';
        card.appendChild(img);

        const meta = document.createElement('div');
        meta.className = 'meta';

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = item.productName || 'Untitled product';
        meta.appendChild(title);

        const desc = document.createElement('div');
        desc.className = 'desc';
        desc.textContent = item.description || '';
        meta.appendChild(desc);

        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = item.price || '';
        meta.appendChild(price);

        // Append meta to card
        card.appendChild(meta);

        // Affiliate link (use affiliateUrl from worker; if empty, this will be '#')
        const a = document.createElement('a');
        a.href = item.affiliateUrl || '#';
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'affiliate-link';
        a.dataset.productName = item.productName || '';
        a.textContent = 'View on Amazon';
        card.appendChild(a);

        container.appendChild(card);
      });
    }

    // Delegated click handler for affiliate links to push affiliate_click to dataLayer,
    // then open the link after a short delay so GTM can register it.
    document.addEventListener('click', function (e) {
      const el = e.target.closest && e.target.closest('a.affiliate-link');
      if (!el) return;

      e.preventDefault();
      const href = el.href;
      const productName = el.dataset.productName || '';

      window.dataLayer.push({
        event: 'affiliate_click',
        productName: productName,
        affiliateUrl: href
      });

      setTimeout(() => {
        window.open(href, '_blank', 'noopener,noreferrer');
      }, 150);
    });

    // Wire up Generate button
    document.getElementById('generateBtn').addEventListener('click', function (evt) {
      evt.preventDefault();
      generateRecommendations();
    });

    // Fire an initial pageview-like event for GTM
    window.dataLayer.push({ event: 'gift_advisor_pageview' });
  </script>
</body>
</html>
